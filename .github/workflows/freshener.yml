name: Package Freshener üçã
on:
  schedule:
    # Early bird; runs well before the flake lock updater (03:14 UTC)
    - cron: '0 1 * * *'
  workflow_dispatch:

jobs:
  wavebox:
    name: Wavebox üì¶
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v6
      - uses: DeterminateSystems/determinate-nix-action@v3
        with:
          extra-conf: |
            eval-cores = 0
      - uses: DeterminateSystems/flakehub-cache-action@v3
      - name: Check for Wavebox update üîç
        id: check
        run: |
          set -euo pipefail

          PKG_NIX="pkgs/wavebox/default.nix"

          LINUX_JSON="https://download.wavebox.app/stable/linux/latest.json"
          DARWIN_JSON="https://download.wavebox.app/stable/macuniversal/latest.json"

          # Extract current versions from the Nix file
          current_linux=$(awk '/^  linux = stdenvNoCC.mkDerivation/,/^  \}\);/ { if ($0 ~ /version = "/) { match($0, /version = "([^"]+)"/, arr); print arr[1]; exit } }' "$PKG_NIX")
          current_darwin=$(awk '/^  darwin = stdenvNoCC.mkDerivation/,/^  \}\);/ { if ($0 ~ /version = "/) { match($0, /version = "([^"]+)"/, arr); print arr[1]; exit } }' "$PKG_NIX")

          echo "Current Linux:  ${current_linux}"
          echo "Current Darwin: ${current_darwin}"

          # Fetch latest versions from Wavebox API
          latest_linux=$(curl -fsSL "$LINUX_JSON" | jq -r '.urls.deb | match("wavebox_(.+)_amd64\\.deb").captures[0].string')
          latest_darwin=$(curl -fsSL "$DARWIN_JSON" | jq -r '.url | match("Install%20Wavebox%20(.+)\\.dmg").captures[0].string')

          if [[ -z "$latest_linux" || "$latest_linux" == "null" || -z "$latest_darwin" || "$latest_darwin" == "null" ]]; then
            echo "‚ùå Could not determine latest Wavebox version"
            exit 1
          fi

          echo "Latest Linux:   ${latest_linux}"
          echo "Latest Darwin:  ${latest_darwin}"

          if [[ "$current_linux" == "$latest_linux" && "$current_darwin" == "$latest_darwin" ]]; then
            echo "‚úÖ Wavebox is up to date"
            echo "updated=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "updated=true" >> "$GITHUB_OUTPUT"
          echo "linux_version=${latest_linux}" >> "$GITHUB_OUTPUT"
          echo "darwin_version=${latest_darwin}" >> "$GITHUB_OUTPUT"

      - name: Update Wavebox package üìù
        if: steps.check.outputs.updated == 'true'
        env:
          LINUX_VERSION: ${{ steps.check.outputs.linux_version }}
          DARWIN_VERSION: ${{ steps.check.outputs.darwin_version }}
        run: |
          set -euo pipefail

          PKG_NIX="pkgs/wavebox/default.nix"

          # Fetch and hash the Linux deb
          linux_url="https://download.wavebox.app/stable/linux/deb/amd64/wavebox_${LINUX_VERSION}_amd64.deb"
          echo "‚¨áÔ∏è  Fetching Linux deb: ${linux_url}"
          linux_store=$(nix store prefetch-file --json --hash-type sha256 "$linux_url" | jq -r '.hash')
          echo "üîë Linux hash: ${linux_store}"

          # Fetch and hash the Darwin dmg
          darwin_url="https://download.wavebox.app/stable/macuniversal/Install%20Wavebox%20${DARWIN_VERSION}.dmg"
          echo "‚¨áÔ∏è  Fetching Darwin dmg: ${darwin_url}"
          darwin_store=$(nix store prefetch-file --json --hash-type sha256 "$darwin_url" | jq -r '.hash')
          echo "üîë Darwin hash: ${darwin_store}"

          # Update Linux version and hash
          sed -i "/^  linux = stdenvNoCC.mkDerivation/,/^  });/s/version = \".*\"/version = \"${LINUX_VERSION}\"/" "$PKG_NIX"
          sed -i "/^  linux = stdenvNoCC.mkDerivation/,/^  });/s|hash = \".*\"|hash = \"${linux_store}\"|" "$PKG_NIX"

          # Update Darwin version and hash
          sed -i "/^  darwin = stdenvNoCC.mkDerivation/,/^  });/s/version = \".*\"/version = \"${DARWIN_VERSION}\"/" "$PKG_NIX"
          sed -i "/^  darwin = stdenvNoCC.mkDerivation/,/^  });/s|hash = \".*\"|hash = \"${darwin_store}\"|" "$PKG_NIX"

          echo "‚úÖ Updated pkgs/wavebox/default.nix"
          git diff "$PKG_NIX"

      - name: Create pull request üöÄ
        if: steps.check.outputs.updated == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN_FOR_UPDATES }}
          LINUX_VERSION: ${{ steps.check.outputs.linux_version }}
        run: |
          BRANCH="wavebox-${LINUX_VERSION}"

          # Check if a PR already exists for this version
          if gh pr list --search "head:${BRANCH}" --json number --jq '.[0].number' | grep -q .; then
            echo "‚è≠Ô∏è  PR already exists for ${BRANCH}"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          git add pkgs/wavebox/default.nix
          git commit -m "chore(wavebox): update to ${LINUX_VERSION}"
          git push -u origin "$BRANCH"

          PR_URL=$(gh pr create \
            --title "chore(wavebox): update to ${LINUX_VERSION}" \
            --body "$(cat <<EOF
          Automated Wavebox update to version ${LINUX_VERSION}.

          Changelog: https://wavebox.io/blog/releases/
          EOF
          )" \
            --label "dependencies,automated")

          echo "üìã Created PR: ${PR_URL}"

          # Extract PR number and enable auto-merge
          PR_NUMBER=$(echo "$PR_URL" | grep -o '[0-9]*$')
          gh pr merge --auto --squash "$PR_NUMBER"

  defold:
    name: Defold üì¶
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v6
      - uses: DeterminateSystems/determinate-nix-action@v3
        with:
          extra-conf: |
            eval-cores = 0
      - uses: DeterminateSystems/flakehub-cache-action@v3
      - name: Check for Defold update üîç
        id: check
        run: |
          set -euo pipefail

          DEFOLD_NIX="pkgs/defold/default.nix"
          BOB_NIX="pkgs/defold-bob/default.nix"
          GDC_NIX="pkgs/defold-gdc/default.nix"

          # Extract current versions and hashes from the Nix files
          current_defold_version=$(sed -n 's/^  version = "\(.*\)";/\1/p' "$DEFOLD_NIX")
          current_bob_version=$(sed -n 's/^  version = "\(.*\)";/\1/p' "$BOB_NIX")
          current_gdc_version=$(sed -n 's/^  version = "\(.*\)";/\1/p' "$GDC_NIX")

          current_defold_hash=$(sed -n 's/.*hash = "\(sha256-[^"]*\)".*/\1/p' "$DEFOLD_NIX")
          current_bob_hash=$(sed -n 's/.*hash = "\(sha256-[^"]*\)".*/\1/p' "$BOB_NIX")
          current_gdc_hash=$(sed -n 's/.*hash = "\(sha256-[^"]*\)".*/\1/p' "$GDC_NIX")

          echo "Current defold:     ${current_defold_version} ${current_defold_hash}"
          echo "Current defold-bob: ${current_bob_version} ${current_bob_hash}"
          echo "Current defold-gdc: ${current_gdc_version} ${current_gdc_hash}"

          # Fetch the latest stable release from GitHub
          latest=$(curl -fsSL "https://api.github.com/repos/defold/defold/releases?per_page=20" \
            | jq -r '[.[] | select(.prerelease == false)][0].tag_name')

          if [[ -z "$latest" || "$latest" == "null" ]]; then
            echo "‚ùå Could not determine latest Defold release"
            exit 1
          fi

          echo "Latest release:     ${latest}"

          # Fetch hashes for all three artefacts
          defold_url="https://github.com/defold/defold/releases/download/${latest}/Defold-x86_64-linux.tar.gz"
          bob_url="https://github.com/defold/defold/releases/download/${latest}/bob.jar"
          gdc_url="https://github.com/defold/defold/releases/download/${latest}/gdc-linux"

          echo "‚¨áÔ∏è  Prefetching Defold artefacts for hash comparison..."
          latest_defold_hash=$(nix store prefetch-file --json --hash-type sha256 "$defold_url" | jq -r '.hash')
          latest_bob_hash=$(nix store prefetch-file --json --hash-type sha256 "$bob_url" | jq -r '.hash')
          latest_gdc_hash=$(nix store prefetch-file --json --hash-type sha256 "$gdc_url" | jq -r '.hash')

          echo "Latest defold hash:     ${latest_defold_hash}"
          echo "Latest defold-bob hash: ${latest_bob_hash}"
          echo "Latest defold-gdc hash: ${latest_gdc_hash}"

          # Compare version AND all hashes; Defold sometimes re-pushes artefacts
          if [[ "$current_defold_version" == "$latest" \
             && "$current_bob_version" == "$latest" \
             && "$current_gdc_version" == "$latest" \
             && "$current_defold_hash" == "$latest_defold_hash" \
             && "$current_bob_hash" == "$latest_bob_hash" \
             && "$current_gdc_hash" == "$latest_gdc_hash" ]]; then
            echo "‚úÖ All Defold packages are up to date"
            echo "updated=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "updated=true" >> "$GITHUB_OUTPUT"
          echo "version=${latest}" >> "$GITHUB_OUTPUT"
          echo "defold_hash=${latest_defold_hash}" >> "$GITHUB_OUTPUT"
          echo "bob_hash=${latest_bob_hash}" >> "$GITHUB_OUTPUT"
          echo "gdc_hash=${latest_gdc_hash}" >> "$GITHUB_OUTPUT"

      - name: Update Defold packages üìù
        if: steps.check.outputs.updated == 'true'
        env:
          VERSION: ${{ steps.check.outputs.version }}
          DEFOLD_HASH: ${{ steps.check.outputs.defold_hash }}
          BOB_HASH: ${{ steps.check.outputs.bob_hash }}
          GDC_HASH: ${{ steps.check.outputs.gdc_hash }}
        run: |
          set -euo pipefail

          DEFOLD_NIX="pkgs/defold/default.nix"
          BOB_NIX="pkgs/defold-bob/default.nix"
          GDC_NIX="pkgs/defold-gdc/default.nix"

          # Update defold
          sed -i 's/^  version = ".*"/  version = "'"${VERSION}"'"/' "$DEFOLD_NIX"
          sed -i 's|hash = "sha256-[^"]*"|hash = "'"${DEFOLD_HASH}"'"|' "$DEFOLD_NIX"
          echo "‚úÖ Updated ${DEFOLD_NIX}"

          # Update defold-bob
          sed -i 's/^  version = ".*"/  version = "'"${VERSION}"'"/' "$BOB_NIX"
          sed -i 's|hash = "sha256-[^"]*"|hash = "'"${BOB_HASH}"'"|' "$BOB_NIX"
          echo "‚úÖ Updated ${BOB_NIX}"

          # Update defold-gdc
          sed -i 's/^  version = ".*"/  version = "'"${VERSION}"'"/' "$GDC_NIX"
          sed -i 's|hash = "sha256-[^"]*"|hash = "'"${GDC_HASH}"'"|' "$GDC_NIX"
          echo "‚úÖ Updated ${GDC_NIX}"

          git diff "$DEFOLD_NIX" "$BOB_NIX" "$GDC_NIX"

      - name: Create pull request üöÄ
        if: steps.check.outputs.updated == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN_FOR_UPDATES }}
          VERSION: ${{ steps.check.outputs.version }}
        run: |
          # Include short hash in branch name to handle artefact re-pushes
          SHORT_HASH=$(echo "${{ steps.check.outputs.defold_hash }}" | cut -c8-15)
          BRANCH="defold-${VERSION}-${SHORT_HASH}"

          # Check if a PR already exists for this exact version+hash
          if gh pr list --search "head:${BRANCH}" --json number --jq '.[0].number' | grep -q .; then
            echo "‚è≠Ô∏è  PR already exists for ${BRANCH}"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          git add pkgs/defold/default.nix pkgs/defold-bob/default.nix pkgs/defold-gdc/default.nix
          git commit -m "chore(defold): update to ${VERSION}"
          git push -u origin "$BRANCH"

          PR_URL=$(gh pr create \
            --title "chore(defold): update to ${VERSION}" \
            --body "$(cat <<EOF
          Automated Defold update to version ${VERSION}.

          Updates all three packages: defold, defold-bob, and defold-gdc.

          Release: https://github.com/defold/defold/releases/tag/${VERSION}
          EOF
          )" \
            --label "dependencies,automated")

          echo "üìã Created PR: ${PR_URL}"

          # Extract PR number and enable auto-merge
          PR_NUMBER=$(echo "$PR_URL" | grep -o '[0-9]*$')
          gh pr merge --auto --squash "$PR_NUMBER"
